<!doctype html>
<html lang="es" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#0b1020" />
  <title>ASTRA · Frontend</title>

  <!-- ================= AUTH GUARD ================= -->
  <script>
    (function () {
      function getToken() {
        try {
          return localStorage.getItem("access_token") ||
                 sessionStorage.getItem("access_token") ||
                 null;
        } catch { return null; }
      }
      function isJwtLike(t) {
        return !!(t && String(t).split(".").length === 3);
      }
      const token = getToken();
      if (!isJwtLike(token)) {
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace("/login?next=" + next);
      }
    })();
  </script>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Assets -->
  <link rel="preload" as="image" href="/static/img/logo_astra_mono.svg">

  <!-- ✅ Preload poses reales de Astra (coach/toasts) -->
  <link rel="preload" as="image" href="/static/img/astra.png">
  <link rel="preload" as="image" href="/static/img/astra_saludo.png">
  <link rel="preload" as="image" href="/static/img/astra_exit.png">
  <link rel="preload" as="image" href="/static/img/astra_checklist.png">

  <!-- CSS -->
  <link rel="stylesheet" href="/static/css/core.css">
  <link rel="stylesheet" href="/static/css/app.css">
  <link rel="stylesheet" href="/static/css/planner.css">
  <link rel="stylesheet" href="/static/css/operativa.css">
  <link rel="stylesheet" href="/static/css/resumen.css">

  <!-- ✅ Toasts: mínimo estilo (para que funcione incluso sin tocar CSS) -->
  <style>
    .astra-toasts{
      position: fixed;
      left: 14px;
      bottom: 14px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .astra-toast{
      pointer-events: auto;
      width: min(420px, calc(100vw - 28px));
      background: rgba(12,16,28,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .astra-toast__row{
      display: flex;
      gap: 12px;
      padding: 12px 12px;
      align-items: flex-start;
    }
    .astra-toast__img{
      width: 46px;
      height: 46px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
      overflow: hidden;
    }
    .astra-toast__img img{
      width: 46px;
      height: 46px;
      object-fit: cover;
      display:block;
    }
    .astra-toast__txt{
      flex: 1 1 auto;
      min-width: 0;
    }
    .astra-toast__title{
      font-weight: 700;
      color: rgba(255,255,255,.92);
      font-size: 14px;
      margin: 0 0 2px 0;
      line-height: 1.15;
    }
    .astra-toast__msg{
      color: rgba(255,255,255,.74);
      font-size: 13px;
      margin: 0;
      line-height: 1.25;
      word-wrap: break-word;
    }
    .astra-toast__actions{
      margin-left: 10px;
      flex: 0 0 auto;
      display:flex;
      align-items:flex-start;
    }
    .astra-toast__close{
      border: 0;
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      width: 28px;
      height: 28px;
      border-radius: 10px;
      cursor: pointer;
      line-height: 1;
    }
  </style>
</head>

<body class="astra-body">

  <noscript>
    <div style="padding:12px 16px; margin:12px; border:1px solid rgba(255,255,255,.15); border-radius:12px; background:rgba(0,0,0,.35); color:rgba(255,255,255,.9);">
      Para usar ASTRA necesitas habilitar JavaScript.
    </div>
  </noscript>

  <!-- TOPBAR -->
  <header class="astra-topbar">
    <a class="astra-brand" href="/app" aria-label="ASTRA Home">
      <img src="/static/img/logo_astra_mono.svg" alt="ASTRA" class="astra-logo" />
      <div class="astra-brandtext">
        <div class="astra-title">ASTRA</div>
        <div class="astra-sub">by CEDEPRO</div>
      </div>
    </a>

    <div class="astra-actions">

      <!-- ADMIN BAR -->
      <div id="adminIesBar" class="d-flex align-items-center gap-2 flex-wrap hidden">
        <input id="iesSearch"
               class="form-control form-control-sm bg-transparent text-light border-secondary"
               placeholder="Buscar IES (nombre o slug)…"
               style="max-width:260px;">

        <select id="iesSelect"
                class="form-select form-select-sm bg-transparent text-light border-secondary"
                style="min-width:320px;">
        </select>

        <button id="btnAddIES" class="btn btn-outline-light btn-sm">+ Nueva IES</button>
        <button id="btnDeleteIES" class="btn btn-outline-danger btn-sm">Eliminar</button>
      </div>

      <!-- pill -->
      <div id="userActive" class="astra-pill hidden"></div>

      <!-- ✅ botones -->
      <button id="btnGuide" class="btn btn-outline-light btn-sm">Guía</button>
      <button id="btnCuenta" class="btn btn-outline-light btn-sm">Cuenta</button>
      <button id="btnResumenGlobal" class="btn btn-outline-light btn-sm">Resumen general</button>
      <button id="btnReset" class="btn btn-light btn-sm">Volver</button>
      <button id="btnLogout" class="btn btn-outline-light btn-sm">Salir</button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container-fluid astra-main">
    <div class="astra-stage">

      <!-- HEADER (título + hint) -->
      <div class="stage-head">
        <div class="stage-left">
          <div class="stage-kicker">Planificador institucional</div>
          <div class="stage-hint">
            Explora los subprogramas (constelación) y abre submódulos desde el panel lateral.
          </div>
        </div>
      </div>

      <!-- CONSTELACIÓN -->
      <section class="constellation" aria-label="Constelación de subprogramas">
        <div id="subprogramasField" class="constellation-field">
          <!-- planner.js inyecta nodos aquí -->
        </div>
      </section>

      <!-- OFFCANVAS (SUBMÓDULOS) -->
      <div class="offcanvas offcanvas-end astra-offcanvas" tabindex="-1" id="submodsCanvas" aria-labelledby="submodsCanvasLabel">
        <div class="offcanvas-header">
          <div>
            <div id="submodsCanvasLabel" class="offcanvas-title h6 m-0">Submódulos</div>
            <div id="submodsMeta" class="text-secondary small">—</div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>

        <div class="offcanvas-body">
          <div class="d-flex gap-2 mb-3">
            <input id="searchSubm"
                   class="form-control form-control-sm bg-transparent text-light border-secondary"
                   placeholder="Buscar submódulo..."
                   type="search" />
            <button id="btnVerResumen" class="btn btn-primary btn-sm" type="button" disabled>
              Ver resumen
            </button>
          </div>

          <div id="submodulosList" class="submods-list">
            <!-- planner.js inyecta lista aquí -->
          </div>

          <div class="mt-3 pt-3 border-top border-secondary-subtle">
            <div class="small text-secondary">
              Selecciona un submódulo para abrir la operativa (inputs) o ir al resumen del submódulo.
            </div>
          </div>
        </div>
      </div>

      <!-- PANELS -->
      <section id="operativaPanel" class="hidden"></section>
      <section id="resumenPanel" class="hidden"></section>

    </div>
  </main>

  <!-- Modal: Crear nueva IES -->
  <div class="modal fade" id="modalAddIES" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title">Crear nueva IES</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label small text-secondary">Nombre</label>
            <input id="newIesNombre" class="form-control bg-transparent text-light border-secondary" placeholder="PUCE">
          </div>

          <div class="mb-2">
            <label class="form-label small text-secondary">Slug</label>
            <input id="newIesSlug" class="form-control bg-transparent text-light border-secondary" placeholder="puce">
            <div class="form-text text-secondary">sin espacios, en minúsculas (ej: “universidad-central”)</div>
          </div>

          <div class="mb-2">
            <label class="form-label small text-secondary">Correo (opcional)</label>
            <input id="newIesEmail" class="form-control bg-transparent text-light border-secondary" placeholder="contacto@puce.edu.ec">
          </div>

          <div class="mb-2">
            <label class="form-label small text-secondary">Clave provisional (opcional)</label>
            <input id="newIesPassword" type="text" class="form-control bg-transparent text-light border-secondary" placeholder="Se puede autogenerar">
          </div>

          <div id="createIesMsg" class="small mt-2"></div>
        </div>

        <div class="modal-footer border-secondary">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnCreateIES" class="btn btn-primary">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Modal: Cuenta (Cambiar clave) -->
  <div class="modal fade" id="modalCuenta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title">Cuenta · Cambiar clave</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="small text-secondary mb-2">
            Recomendado: cambia la clave provisional por una personal.
          </div>

          <div class="mb-2">
            <label class="form-label small text-secondary">Clave actual</label>
            <input id="pwOld" type="password" class="form-control bg-transparent text-light border-secondary" autocomplete="current-password">
          </div>

          <div class="mb-2">
            <label class="form-label small text-secondary">Nueva clave</label>
            <input id="pwNew" type="password" class="form-control bg-transparent text-light border-secondary" autocomplete="new-password">
          </div>

          <div class="mb-2">
            <label class="form-label small text-secondary">Repetir nueva clave</label>
            <input id="pwNew2" type="password" class="form-control bg-transparent text-light border-secondary" autocomplete="new-password">
          </div>

          <div id="pwMsg" class="small mt-2"></div>
        </div>

        <div class="modal-footer border-secondary">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnSavePw" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Contenedor de mensajes emergentes -->
  <div id="astraToasts" class="astra-toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JS -->
  <script src="/static/js/core.js"></script>
  <script src="/static/js/resumen.js" defer></script>
  <script src="/static/js/planner.js?v=445" defer></script>
  <script src="/static/js/admin.js?v=1" defer></script>

  <!-- ✅ Hook de Guía + Cuenta (sin tocar planner.js) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ---- Guía ----
      const btnGuide = document.getElementById("btnGuide");
      if (btnGuide) {
        btnGuide.addEventListener("click", () => {
          try {
            if (window.ASTRA && typeof window.ASTRA.openGuide === "function") {
              window.ASTRA.openGuide();
            }
          } catch (e) {
            console.warn("No se pudo abrir la guía:", e);
          }
        });
      }

      // ---- Cuenta / Cambiar clave ----
      const btnCuenta = document.getElementById("btnCuenta");
      const modalCuentaEl = document.getElementById("modalCuenta");
      const modalCuenta = (modalCuentaEl && window.bootstrap) ? new bootstrap.Modal(modalCuentaEl) : null;

      btnCuenta?.addEventListener("click", () => {
        try {
          document.getElementById("pwMsg").textContent = "";
          modalCuenta?.show();
        } catch (e) {
          console.warn("No se pudo abrir Cuenta:", e);
        }
      });

      function setPwMsg(text, ok) {
        const el = document.getElementById("pwMsg");
        if (!el) return;
        el.className = ok ? "small text-success mt-2" : "small text-danger mt-2";
        el.textContent = text || "";
      }

      async function callChangePassword(payload) {
        const A = window.ASTRA || {};
        const api = (typeof A.api === "function") ? A.api : null;
        if (!api) throw new Error("A.api no está disponible (core.js).");

        const candidates = [
          "/auth/me/password",
          "/auth/change-password",
          "/users/me/password",
          "/usuarios/me/password",
        ];

        let lastErr = null;

        for (const path of candidates) {
          try {
            return await api(path, {
              method: "POST",
              body: JSON.stringify(payload),
            });
          } catch (e) {
            const status = e?.status || e?.response?.status || null;
            if (status === 404) { lastErr = e; continue; } // prueba el siguiente
            lastErr = e;
            throw e; // errores reales (401/403/422/500) se muestran
          }
        }
        throw lastErr || new Error("No existe endpoint de cambio de clave.");
      }

      document.getElementById("btnSavePw")?.addEventListener("click", async () => {
        const oldPw = (document.getElementById("pwOld")?.value || "").trim();
        const newPw = (document.getElementById("pwNew")?.value || "").trim();
        const newPw2 = (document.getElementById("pwNew2")?.value || "").trim();

        if (newPw.length < 8) return setPwMsg("La nueva clave debe tener al menos 8 caracteres.", false);
        if (newPw !== newPw2) return setPwMsg("La nueva clave no coincide.", false);

        try {
          setPwMsg("Guardando…", true);

          await callChangePassword({
            old_password: oldPw,
            new_password: newPw,
          });

          setPwMsg("Clave actualizada ✓", true);

          // Limpia
          document.getElementById("pwOld").value = "";
          document.getElementById("pwNew").value = "";
          document.getElementById("pwNew2").value = "";

          setTimeout(() => modalCuenta?.hide(), 700);
        } catch (e) {
          console.error(e);
          const status = e?.status || e?.response?.status || null;
          if (status === 401) return setPwMsg("Sesión inválida. Vuelve a iniciar sesión.", false);
          if (status === 403) return setPwMsg("No tienes permisos para cambiar la clave.", false);
          setPwMsg("No se pudo cambiar la clave. Verifica la clave actual o el endpoint.", false);
        }
      });
    });
  </script>
</body>
</html>
